# -*- coding: utf-8 -*-
"""qwen3max_guide_segm.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1yBRAJt0r5DfLxv5LzUvxhdweCIB9c0R7
"""

import os
import time
import random
import pandas as pd
from tqdm import tqdm
from openai import OpenAI



api_key = ""


# Endpoint international (souvent le plus simple hors Chine).
# Si tu es sur rÃ©gion Chine/produit diffÃ©rent, essaie :
#   base_url="https://dashscope.aliyuncs.com/compatible-mode/v1"
client = OpenAI(
    api_key=api_key,
    base_url="https://dashscope-intl.aliyuncs.com/compatible-mode/v1",
)

# =========================
# 1. MODÃˆLE
# =========================
MODEL_NAME = "qwen3-max"

# =========================
# 1bis. RETRY / THROTTLE (anti 429/503)
# =========================
MAX_RETRIES = 6
MAX_BACKOFF_SEC = 25.0
THROTTLE_PER_CALL_SEC = 0.10

def _is_retryable_error(e: Exception) -> bool:
    msg = str(e).lower()
    return (
        "429" in msg or "rate" in msg or
        "503" in msg or "unavailable" in msg or
        "overload" in msg or "timeout" in msg or
        "server" in msg
    )

def chat_completion_with_retry(messages, temperature=0, max_tokens=40):
    last_exc = None
    for attempt in range(MAX_RETRIES):
        try:
            resp = client.chat.completions.create(
                model=MODEL_NAME,
                messages=messages,
                temperature=temperature,
                max_tokens=max_tokens,
            )
            time.sleep(THROTTLE_PER_CALL_SEC)
            return resp
        except Exception as e:
            last_exc = e
            if _is_retryable_error(e):
                wait = min(MAX_BACKOFF_SEC, (2 ** attempt) + random.uniform(0, 1))
                print(f"âš ï¸ API retryable error â€” retry in {wait:.1f}s ({attempt+1}/{MAX_RETRIES})")
                time.sleep(wait)
                continue
            raise
    raise RuntimeError(f"Ã‰chec aprÃ¨s retries. DerniÃ¨re erreur: {last_exc}")

# =========================
# 2. PROMPTS DES TESTS (SANS FEW-SHOT) â€” INCHANGÃ‰S
# =========================

CRAN_PROMPT = """
Tu es linguiste annotateur. RÃ©ponds UNIQUEMENT par "OUI" ou "NON".

TEST CRAN â€” mot exclusivement figÃ©
Question : lâ€™expression contient-elle un mot exclusivement figÃ© ?

Un mot exclusivement figÃ© :
- nâ€™existe pas comme mot autonome,
- nâ€™apparaÃ®t jamais en dehors de lâ€™expression,
- nâ€™a plus dâ€™usage productif moderne.

Exemple OUI : Â« us Â» dans Â« us et coutumes Â»
Exemple NON : Â« bleu Â» dans Â« cordon bleu Â»

RÃ©ponds uniquement OUI ou NON.
Puis ajoute UNE phrase trÃ¨s courte expliquant la raison.
Format obligatoire :
OUI/NON
Explication : <phrase trÃ¨s courte>

Expression : {expression}
Contexte : {contexte}
"""

MORPH_PROMPT = """
Tu es linguiste annotateur. RÃ©ponds UNIQUEMENT par "OUI" ou "NON".

TEST MORPH â€” modification morphologique
Question : la flexion (pluriel, genre) rend-elle lâ€™expression agrammaticale ou Ã©trange ?

Exemple OUI : Â« garde du corps Â» â†’ Â« gardes du corps Â»
Exemple NON : Â« livre scolaire Â» â†’ Â« livres scolaires Â»

RÃ©ponds uniquement OUI ou NON.
Puis ajoute UNE phrase trÃ¨s courte expliquant la raison.
Format obligatoire :
OUI/NON
Explication : <phrase trÃ¨s courte>

Expression : {expression}
Contexte : {contexte}
"""

SYNT_PROMPT = """
Tu es linguiste annotateur. RÃ©ponds UNIQUEMENT par "OUI" ou "NON".

TEST SYNT â€” modification syntaxique
Question : un changement dâ€™ordre ou de structure modifie-t-il fortement le sens ou le rend-il agrammaticale ou bizzare ?

Exemple OUI : Â« pomme de terre Â» â‰  Â« pomme terrestre Â»
Exemple NON : Â« comitÃ© rÃ©gional Â» â‰ˆ Â« comitÃ© de la rÃ©gion Â»

RÃ©ponds uniquement OUI ou NON.
Puis ajoute UNE phrase trÃ¨s courte expliquant la raison.
Format obligatoire :
OUI/NON
Explication : <phrase trÃ¨s courte>

Expression : {expression}
Contexte : {contexte}
"""

LEX_PROMPT = """
Tu es linguiste annotateur. RÃ©ponds UNIQUEMENT par "OUI" ou "NON".

TEST LEX â€” substitution lexicale
Question : remplacer un Ã©lÃ©ment par un synonyme rend-il lâ€™expression anormale, agrammaticale ou bizzare ?

Exemple OUI : Â« eau de vie Â» â†’ Â« boisson de vie Â»
Exemple NON : Â« prix rÃ©duit Â» â†’ Â« tarif rÃ©duit Â»

RÃ©ponds uniquement OUI ou NON.
Puis ajoute UNE phrase trÃ¨s courte expliquant la raison.
Format obligatoire :
OUI/NON
Explication : <phrase trÃ¨s courte>

Expression : {expression}
Contexte : {contexte}
"""

MODIF_PROMPT = """
Tu es linguiste annotateur. RÃ©ponds UNIQUEMENT par "OUI" ou "NON".

TEST MODIF â€” insertion dâ€™un modifieur
Question : lâ€™insertion dâ€™un modifieur (adjectif/adverbe) interne rend-elle lâ€™expression anormale, agrammaticale ou bizzare ?

Exemple OUI : Â« pomme verte de terre Â»
Exemple NON : Â« roman contemporain policier Â»

RÃ©ponds uniquement OUI ou NON.
Puis ajoute UNE phrase trÃ¨s courte expliquant la raison.
Format obligatoire :
OUI/NON
Explication : <phrase trÃ¨s courte>

Expression : {expression}
Contexte : {contexte}
"""

SEMREST_PROMPT = """
Tu es linguiste annotateur. RÃ©ponds UNIQUEMENT par "OUI" ou "NON".

TEST SEM-REST â€” restrictions sÃ©mantiques
Question : la tÃªte nominale (le nom principal de l'expression) telle qu'elle est utilisÃ©e dans cette expression (dans son sens contextuel) a-t-elle un ensemble restreint de collocatifs naturels ?

Exemple OUI : Â« professeur de linguistique Â» â†’ mais aussi Â« professeur de maths Â», Â« professeur de chimie Â», Â« professeur de littÃ©rature Â» (ensemble restreint aux domaines acadÃ©miques)
Exemple NON : Â« Ã©vÃ©nement majeur Â» â†’ mais aussi Â« Ã©vÃ©nement local Â», Â« Ã©vÃ©nement imprÃ©vu Â», Â« Ã©vÃ©nement politique Â», etc. (ensemble trÃ¨s ouvert)

âš ï¸ Attention : Tu dois analyser UNIQUEMENT la tÃªte nominale, pas lâ€™expression entiÃ¨re.
On vÃ©rifie avec quels collocatifs naturels se combine la tÃªte nominale seule.

Exemples :
- dans Â« roman policier Â» â†’ la tÃªte nominale = Â« roman Â», pas Â« roman policier Â»
- dans Â« pomme de terre Â» â†’ la tÃªte nominale = Â« pomme Â», pas Â« pomme de terre Â»

Ne prends jamais lâ€™expression complÃ¨te comme base de comparaison.
Toujours la tÃªte nominale seule.

âš ï¸ Attention : Dans ces donnÃ©es, il est rare que la rÃ©ponse Ã  ce test est NON.

RÃ©ponds uniquement OUI ou NON.
Puis ajoute UNE phrase trÃ¨s courte expliquant la raison.
Format obligatoire :
OUI/NON
Explication : <phrase trÃ¨s courte>

Expression : {expression}
Contexte : {contexte}
"""

ID_PROMPT = """
Tu es linguiste annotateur. RÃ©ponds UNIQUEMENT par "OUI" ou "NON".

TEST ID â€” type naturel
Question : lâ€™expression dÃ©signe-t-elle une sous-catÃ©gorie naturelle et littÃ©rale du noyau nominal ?

âš ï¸ Attention : tu dois identifier la tÃªte syntaxique de lâ€™expression :
le nom qui constitue le noyau de la construction nominale.

Pour rÃ©pondre OUI, le noyau nominal doit garder son sens et lâ€™expression doit dÃ©signer un type de ce nom. La rÃ©ponse est plus souvent OUI que NON, donc dans les cas d'incertitude penche vers OUI.

Exemples ID = NON :
- Â« Ã®le flottante Â» (dessert) : ce nâ€™est pas un type d'Ã®le, c'est un dessert
- Â« forÃªt noire Â» (gÃ¢teau) : ce nâ€™est pas un type de forÃªt, c'est un gÃ¢teau

Exemple ID = OUI :
- Â« Ã©vÃ©nement culturel Â» : câ€™est un type dâ€™Ã©vÃ©nement
- Â« chaise en bois Â» : câ€™est un type de chaise
- Â« vÃ©hicule Ã©lectrique Â» : câ€™est un type de vÃ©hicule
- Â« bouteille en plastique Â» : câ€™est un type de bouteille
- Â« porte coulissante Â» : câ€™est un type de porte

RÃ©ponds uniquement OUI ou NON.
Puis ajoute UNE phrase trÃ¨s courte expliquant la raison.
Format obligatoire :
OUI/NON
Explication : <phrase trÃ¨s courte>

Expression : {expression}
Contexte : {contexte}
"""

OPAC_PROMPT = """
Tu es linguiste annotateur. RÃ©ponds UNIQUEMENT par "OUI" ou "NON".

ğŸ”µ TEST OPAC â€” opacitÃ© sÃ©mantique
Question : le sens global ne correspond-il pas Ã  la somme des sens littÃ©raux des composants ?

Si le noyau nominal nâ€™est pas littÃ©ral â†’ OPAC = OUI.

Exemples OUI :
- Â« Ã®le flottante Â» (pas une Ã®le flotte)
- Â« forÃªt noire Â» (pas une forÃªt qui est noire)
- Â« lune de miel Â» (pas une lune construite de miel)

Exemples NON :
- Â« analyse des donnÃ©es Â» (c'est une analyse impliquant des donnÃ©es)
- Â« dÃ©cision administrative Â» (c'est une dÃ©cision qui est de type administratif)

Format obligatoire :
OUI/NON
Explication : <phrase trÃ¨s courte>

Expression : {expression}
Contexte : {contexte}
"""

# =========================
# 3. APPEL Dâ€™UN TEST
# =========================

def ask_test(prompt_template, expression, examples):
    contexte = "" if examples is None or pd.isna(examples) else str(examples)
    prompt = prompt_template.format(expression=expression, contexte=contexte)

    resp = chat_completion_with_retry(
        messages=[{"role": "user", "content": prompt}],
        temperature=0,
        max_tokens=40,
    )

    full = (resp.choices[0].message.content or "").strip()
    first_line = full.split("\n")[0].strip().upper()
    decision = "OUI" if first_line == "OUI" else "NON"

    explanation = ""
    if "\n" in full:
        explanation = full.split("\n", 1)[1].strip()

    return decision, explanation

# =========================
# 4. Ğ”Ğ•Ğ Ğ•Ğ’Ğ Ğ Ğ•Ğ¨Ğ•ĞĞ˜Ğ™
# =========================

def annotate_expression(expression, examples):
    tests = {}

    d, e = ask_test(CRAN_PROMPT, expression, examples)
    tests["CRAN"] = (d, e)
    if d == "OUI":
        return tests, "expression_idiomatique"

    d, e = ask_test(MORPH_PROMPT, expression, examples)
    tests["MORPH"] = (d, e)
    if d == "OUI":
        d2, e2 = ask_test(ID_PROMPT, expression, examples)
        tests["ID"] = (d2, e2)
        if d2 == "NON":
            return tests, "expression_idiomatique"
        d3, e3 = ask_test(OPAC_PROMPT, expression, examples)
        tests["OPAC"] = (d3, e3)
        return tests, "collocation_opaque" if d3 == "OUI" else "collocation_transparente"

    d, e = ask_test(SYNT_PROMPT, expression, examples)
    tests["SYNT"] = (d, e)
    if d == "OUI":
        d2, e2 = ask_test(ID_PROMPT, expression, examples)
        tests["ID"] = (d2, e2)
        if d2 == "NON":
            return tests, "expression_idiomatique"
        d3, e3 = ask_test(OPAC_PROMPT, expression, examples)
        tests["OPAC"] = (d3, e3)
        return tests, "collocation_opaque" if d3 == "OUI" else "collocation_transparente"

    d, e = ask_test(LEX_PROMPT, expression, examples)
    tests["LEX"] = (d, e)
    if d == "OUI":
        d2, e2 = ask_test(ID_PROMPT, expression, examples)
        tests["ID"] = (d2, e2)
        if d2 == "NON":
            return tests, "expression_idiomatique"
        d3, e3 = ask_test(OPAC_PROMPT, expression, examples)
        tests["OPAC"] = (d3, e3)
        return tests, "collocation_opaque" if d3 == "OUI" else "collocation_transparente"

    d, e = ask_test(MODIF_PROMPT, expression, examples)
    tests["MODIF"] = (d, e)
    if d == "OUI":
        d2, e2 = ask_test(ID_PROMPT, expression, examples)
        tests["ID"] = (d2, e2)
        if d2 == "NON":
            return tests, "expression_idiomatique"
        d3, e3 = ask_test(OPAC_PROMPT, expression, examples)
        tests["OPAC"] = (d3, e3)
        return tests, "collocation_opaque" if d3 == "OUI" else "collocation_transparente"

    d, e = ask_test(SEMREST_PROMPT, expression, examples)
    tests["SEM-REST"] = (d, e)
    if d == "NON":
        return tests, "expression_libre"

    d, e = ask_test(ID_PROMPT, expression, examples)
    tests["ID"] = (d, e)
    if d == "NON":
        return tests, "expression_idiomatique"

    d, e = ask_test(OPAC_PROMPT, expression, examples)
    tests["OPAC"] = (d, e)
    return tests, "collocation_opaque" if d == "OUI" else "collocation_transparente"

# =========================
# 5. FORMAT llm_raw_response
# =========================

def generate_annotation_with_llm(expression, examples):
    tests, category = annotate_expression(expression, examples)

    lines = []
    lines.append(f"CATÃ‰GORIE FINALE : {category}")
    lines.append("Explications des tests :")

    for t in ["CRAN", "MORPH", "SYNT", "LEX", "MODIF", "SEM-REST", "ID", "OPAC"]:
        if t in tests:
            d, e = tests[t]
            lines.append(f"{t} : {d}")
            if e:
                lines.append(f"  Explication : {e}")

    return "\n".join(lines)

# =========================
# 6. TRAITEMENT EXCEL
# =========================

input_file = "nominal_part_8.xlsx"
df = pd.read_excel(input_file)
df["llm_raw_response"] = None

for idx, row in tqdm(df.iterrows(), total=len(df), desc="Annotation EP (Qwen3-Max)"):
    expr = row.get("expression")
    ex = row.get("examples_joined")

    if pd.isna(expr) or not str(expr).strip():
        df.at[idx, "llm_raw_response"] = "N/A"
        continue

    df.at[idx, "llm_raw_response"] = generate_annotation_with_llm(expr, ex)

output_file = "annotated_nominal_part_8_qwen3_max_instruct.xlsx"
df.to_excel(output_file, index=False)

print(f"Saved: {output_file}")